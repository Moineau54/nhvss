import os


def vulnerability_scan(file_name):

    current_dir = os.getcwd()
    os.popen("sudo nmap --script-updatedb")
    os.popen("cd " + os.getcwd())

    response = []
    file_name2 = "scan_history/" + file_name
    file_list = []
    with open(file_name2, "r") as file:
        for line in file:
            file_list.append(line)
        file.close()

    for line in file_list:
        line = line.split(" | ")[0]
        ip = line.strip()
        print("Scanning " + ip + " for vulnerabilities")

        for line in os.popen("sudo nmap -sS -A -O --script vulners " + ip):
            # print(line.strip())
            response.append(line)

        if "Host seems down" in response:
            print(ip + " is down")
        else:
            os.system(
                "mkdir -p "
                + os.getcwd()
                + "/scanned_hosts/"
                + file_name.split("_hosts.txt")[0]
                + "/"
            )
            new_folder = (
                os.getcwd() + "/scanned_hosts/" + file_name.split("_hosts.txt")[0] + "/"
            ).replace(" ", "\ ")
            newest_folder = file_name.split("_hosts.txt")[0]
            scaned_host_dir_list = f'{current_dir}/scanned_hosts/'
            if newest_folder not in os.listdir(scaned_host_dir_list):
                os.mkdir(new_folder)
            # os.mkdir("scanned_hosts/" + file_name.split("_hosts.txt")[0] + "/")
            folder_content = os.listdir("scanned_hosts/" + file_name.split("_hosts.txt")[0] + "/")
            count = 0
            for i in folder_content:
                if i == ip + ".txt":
                    count += 1

            new_Path = "scanned_hosts/" + file_name.split("_hosts.txt")[0] + "/" + ip + ".txt"
            os.popen("touch " + new_Path)
            with open(new_Path, "w") as file:
                for i in response:
                    file.writelines(i)



# This call to the function vulnerability_scan() is here for debugging purposes. Uncomment it if needed.
# path = os.getcwd()
# vulnerability_scan(path)
