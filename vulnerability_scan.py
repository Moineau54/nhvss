import os


def vulnerability_scan(file_name):


    os.popen("sudo nmap --script-updatedb")
    #os.system("cd " + os.getcwd())
    os.popen("cd " + os.getcwd())
   # os.system("clear")

    response = []
    file_name2 = "scan_history/" + file_name
    file_list = []
    with open(file_name2, "r") as file:
        for line in file:
            file_list.append(line)
        file.close()

    for line in file_list:
        line = line.split(" | ")[0]
        ip = line.strip()
        print("Scanning " + ip + " for vulnerabilities")

        for line in os.popen("sudo nmap -sS -A -O --script vulners " + ip):
            # print(line.strip())
            response.append(line)

        if "Host seems down" in response:
            print(ip + " is down")
        else:
            os.system(
                "mkdir -p "
                + os.getcwd()
                + "/scanned_hosts/"
                + file_name.split("_hosts.txt")[0]
                + "/"
            )
            new_folder = (
                os.getcwd() + "/scanned_hosts/" + file_name.split("_hosts.txt")[0] + "/"
            )
            os.mkdir(new_folder)
            os.popen("touch " + new_folder + ip + ".txt")
            with open(new_folder + ip + ".txt", "w") as file:
                for i in response:
                    file.writelines(i)

                # print(ip + " is up")


# This call to the function vulnerability_scan() is here for debugging purposes. Uncomment it if needed.
# path = os.getcwd()
# vulnerability_scan(path)
